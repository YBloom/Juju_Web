# å‘¼å•¦åœˆä¸Šæ–°é€šçŸ¥è°ƒè¯•æŒ‡å—

## é—®é¢˜ï¼šç”¨æˆ·åé¦ˆä¸Šæ–°ä¸ä¼šæç¤º

### å¯èƒ½çš„åŸå› 

1. **å®šæ—¶ä»»åŠ¡æœªè¿è¡Œ**
2. **ç”¨æˆ·å…³æ³¨æ¨¡å¼è®¾ç½®é”™è¯¯**
3. **æ•°æ®æ¯”å¯¹é€»è¾‘é—®é¢˜**ï¼ˆ`Hlq.compare_to_database_async()`ï¼‰
4. **æ¶ˆæ¯ç”Ÿæˆé€»è¾‘é—®é¢˜**ï¼ˆ`__generate_announce_text`ï¼‰
5. **æ¶ˆæ¯å‘é€å¤±è´¥**ï¼ˆAPIè°ƒç”¨é—®é¢˜ï¼‰
6. **æ•°æ®åˆ·æ–°é—´éš”å¤ªé•¿**ï¼Œç”¨æˆ·åœ¨åˆ·æ–°å‰å·²ç»æ‰‹åŠ¨æŸ¥çœ‹

---

## è°ƒè¯•æµç¨‹

### ç¬¬ä¸€æ­¥ï¼šæ£€æŸ¥å®šæ—¶ä»»åŠ¡çŠ¶æ€

ä½¿ç”¨å‘½ä»¤ï¼š
```
/debugé€šçŸ¥ check
```

æŸ¥çœ‹å†…å®¹ï¼š
- âœ… å®šæ—¶ä»»åŠ¡æ˜¯å¦åœ¨è¿è¡Œä¸­ï¼Ÿ
- â° æ£€æµ‹é—´éš”æ˜¯å¤šå°‘ç§’ï¼Ÿ
- ğŸ”„ ä»»åŠ¡æ˜¯å¦å·²å®Œæˆï¼ˆåº”è¯¥æ˜¯"å¦"ï¼‰ï¼Ÿ

**å¦‚æœä»»åŠ¡æœªè¿è¡Œï¼š**
```
/å‘¼å•¦åœˆæ£€æµ‹  # ç®¡ç†å‘˜å‘½ä»¤ï¼Œå¼€å¯æ£€æµ‹
```

---

### ç¬¬äºŒæ­¥ï¼šæ£€æŸ¥ç”¨æˆ·è®¾ç½®

ä½¿ç”¨å‘½ä»¤ï¼š
```
/debugé€šçŸ¥ user
```

æŸ¥çœ‹å†…å®¹ï¼š
- ğŸ“Œ **å…¨å±€æ¨¡å¼**æ˜¯ä»€ä¹ˆï¼Ÿ
  - æ¨¡å¼0ï¼šä¸æ¥å—ä»»ä½•é€šçŸ¥ âŒ
  - æ¨¡å¼1ï¼šä¸Šæ–°/è¡¥ç¥¨ âœ…
  - æ¨¡å¼2ï¼šä¸Šæ–°/è¡¥ç¥¨/å›æµ âœ…
  - æ¨¡å¼3ï¼šä¸Šæ–°/è¡¥ç¥¨/å›æµ/å¢å‡ç¥¨ âœ…

- ğŸ“‹ æ˜¯å¦å…³æ³¨äº†ç‰¹å®šå‰§ç›®ï¼Ÿ
- ğŸ« æ˜¯å¦å…³æ³¨äº†ç‰¹å®šåœºæ¬¡ï¼Ÿ

**å¸¸è§é—®é¢˜ï¼š**
- âŒ ç”¨æˆ·æ¨¡å¼è®¾ç½®ä¸º 0ï¼ˆä¸æ¥å—é€šçŸ¥ï¼‰
  - è§£å†³ï¼š`/å‘¼å•¦åœˆé€šçŸ¥ 1` ï¼ˆæˆ– 2ã€3ï¼‰

- âŒ ç”¨æˆ·åªå…³æ³¨äº†ç‰¹å®šå‰§ç›®/åœºæ¬¡ï¼Œä½†ä¸Šæ–°çš„æ˜¯å…¶ä»–å‰§ç›®
  - è§£å†³ï¼šè®¾ç½®å…¨å±€æ¨¡å¼ï¼Œæˆ–å…³æ³¨æ›´å¤šå‰§ç›®

---

### ç¬¬ä¸‰æ­¥ï¼šä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®æµ‹è¯•

ä½¿ç”¨å‘½ä»¤ï¼š
```
/debugé€šçŸ¥ mock
```

è¿™ä¼šï¼š
1. åˆ›å»º 4 å¼ æ¨¡æ‹Ÿç¥¨ï¼ˆä¸Šæ–°ã€è¡¥ç¥¨ã€å›æµï¼‰
2. æ ¹æ®ä½ çš„è®¾ç½®ç”Ÿæˆé€šçŸ¥æ¶ˆæ¯
3. æ˜¾ç¤ºæ¶ˆæ¯é¢„è§ˆ

**å¦‚æœæ²¡æœ‰ç”Ÿæˆæ¶ˆæ¯ï¼š**
è¯´æ˜é—®é¢˜åœ¨ç”¨æˆ·è®¾ç½®å±‚é¢ï¼Œå›åˆ°ç¬¬äºŒæ­¥æ£€æŸ¥ã€‚

**å¦‚æœç”Ÿæˆäº†æ¶ˆæ¯ï¼š**
è¯´æ˜æ¶ˆæ¯ç”Ÿæˆé€»è¾‘æ­£å¸¸ï¼Œé—®é¢˜å¯èƒ½åœ¨ï¼š
- æ•°æ®æ¯”å¯¹ç¯èŠ‚ï¼ˆæ²¡æœ‰æ£€æµ‹åˆ°çœŸå®çš„ä¸Šæ–°ï¼‰
- æ¶ˆæ¯å‘é€ç¯èŠ‚

---

### ç¬¬å››æ­¥ï¼šæ£€æŸ¥çœŸå®æ•°æ®æ¯”å¯¹

æ‰‹åŠ¨è§¦å‘ä¸€æ¬¡åˆ·æ–°ï¼š
```
/refresh  # ç®¡ç†å‘˜å‘½ä»¤
```

è§‚å¯Ÿï¼š
- æ˜¯å¦æ”¶åˆ°é€šçŸ¥ï¼Ÿ
- æ—¥å¿—ä¸­æ˜¯å¦æœ‰é”™è¯¯ï¼Ÿ

**æŸ¥çœ‹æ—¥å¿—ï¼š**
```powershell
# æŸ¥çœ‹æœ€æ–°æ—¥å¿—
Get-Content f:\MusicalBot\logs\bot.log -Tail 50
```

å…³é”®æ—¥å¿—æœç´¢ï¼š
```powershell
# æœç´¢"å‘¼å•¦åœˆ"ç›¸å…³æ—¥å¿—
Select-String -Path f:\MusicalBot\logs\bot.log -Pattern "å‘¼å•¦åœˆ|hulaquan|announcer" | Select-Object -Last 20
```

---

### ç¬¬äº”æ­¥ï¼šæ·±åº¦è°ƒè¯•ï¼ˆä»£ç å±‚é¢ï¼‰

å¦‚æœä»¥ä¸Šæ­¥éª¤éƒ½æ­£å¸¸ï¼Œä½†ä»ç„¶æ²¡æœ‰é€šçŸ¥ï¼Œéœ€è¦ï¼š

#### 5.1 æ·»åŠ è¯¦ç»†æ—¥å¿—

åœ¨ `on_hulaquan_announcer` æ–¹æ³•ä¸­æ·»åŠ æ—¥å¿—ï¼š

```python
@user_command_wrapper("hulaquan_announcer")
async def on_hulaquan_announcer(self, test=False, manual=False, announce_admin_only=False):
    log.info(f"ğŸ”„ å¼€å§‹æ‰§è¡Œå‘¼å•¦åœˆä¸Šæ–°æ£€æµ‹ï¼Œmanual={manual}, announce_admin_only={announce_admin_only}")
    
    try:
        result = await Hlq.compare_to_database_async()
        
        # æ·»åŠ è¯¦ç»†æ—¥å¿—
        log.info(f"ğŸ“Š æ•°æ®æ¯”å¯¹ç»“æœç»Ÿè®¡ï¼š")
        for cat, items in result["categorized"].items():
            if items:
                log.info(f"  - {cat}: {len(items)} æ¡")
        
        # ... åŸæœ‰ä»£ç 
        
        # åœ¨å‘é€æ¶ˆæ¯æ—¶æ·»åŠ æ—¥å¿—
        for user_id, user in _users.items():
            messages = self.__generate_announce_text(...)
            log.info(f"ğŸ‘¤ ä¸ºç”¨æˆ· {user_id} ç”Ÿæˆäº† {len(messages)} ç»„æ¶ˆæ¯")
            
            for i in messages:
                m = "\n\n".join(i)
                log.info(f"ğŸ“¤ å‡†å¤‡å‘é€æ¶ˆæ¯ç»™ {user_id}ï¼Œé•¿åº¦: {len(m)}")
                r = await self.api.post_private_msg(user_id, m)
                log.info(f"ğŸ“¬ å‘é€ç»“æœ: retcode={r.get('retcode')}")
                # ...
```

#### 5.2 æ£€æŸ¥ `Hlq.compare_to_database_async()` 

è¿™æ˜¯å…³é”®çš„æ•°æ®æ¯”å¯¹æ–¹æ³•ï¼Œéœ€è¦ç¡®è®¤ï¼š
- æ˜¯å¦æ­£å¸¸è¿æ¥åˆ°å‘¼å•¦åœˆAPIï¼Ÿ
- æ˜¯å¦æ­£ç¡®æ¯”å¯¹äº†æ–°æ—§æ•°æ®ï¼Ÿ
- `categorized` å­—å…¸ä¸­æ˜¯å¦æœ‰æ•°æ®ï¼Ÿ

æ·»åŠ æµ‹è¯•ä»£ç ï¼š

```python
# åœ¨ Python REPL æˆ–æµ‹è¯•è„šæœ¬ä¸­
from plugins.Hulaquan.data_managers import Hlq
import asyncio

async def test_compare():
    result = await Hlq.compare_to_database_async()
    print("Events:", len(result.get("events", {})))
    print("Categorized:")
    for cat, items in result.get("categorized", {}).items():
        print(f"  {cat}: {len(items)}")
    return result

# è¿è¡Œ
result = asyncio.run(test_compare())
```

#### 5.3 æµ‹è¯•æ¶ˆæ¯ç”Ÿæˆé€»è¾‘

ä½¿ç”¨ `debug_announcer.py` ä¸­çš„å·¥å…·ï¼š

```python
from plugins.Hulaquan.debug_announcer import AnnouncerDebugger

debugger = AnnouncerDebugger(plugin_instance)

# åˆ›å»ºçœŸå®åœºæ™¯çš„æ¨¡æ‹Ÿæ•°æ®
mock_tickets = [
    debugger.create_mock_ticket("10001", "1001", "new", "ä½ å…³æ³¨çš„å‰§ç›®", "2025-10-20", "AåŒº", "100"),
]
mock_result = debugger.create_mock_result(mock_tickets)

# æµ‹è¯•ç‰¹å®šç”¨æˆ·
messages = debugger.test_generate_announce_text(mock_result, "ç”¨æˆ·QQå·")
```

---

## å¸¸è§é—®é¢˜è§£ç­”

### Q1: å®šæ—¶ä»»åŠ¡åœ¨è¿è¡Œï¼Œä½†ä»ä¸æ”¶åˆ°é€šçŸ¥ï¼Ÿ

**æ’æŸ¥ç‚¹ï¼š**
1. æ£€æŸ¥ `Hlq.compare_to_database_async()` æ˜¯å¦æ€»æ˜¯è¿”å›ç©ºçš„ `categorized`
2. æ£€æŸ¥æ˜¯å¦å› ä¸ºæ•°æ®å¼‚å¸¸è¢«æ‹¦æˆªï¼ˆä»£ç ä¸­æœ‰ `if len(categorized["æ–°"]) >= 400` çš„ä¿æŠ¤é€»è¾‘ï¼‰
3. æ£€æŸ¥æ—¶é—´é—´éš”æ˜¯å¦å¤ªé•¿ï¼Œç”¨æˆ·å·²ç»é€šè¿‡å…¶ä»–æ–¹å¼çŸ¥é“ä¸Šæ–°

**è§£å†³æ–¹æ¡ˆï¼š**
- å‡å°æ£€æµ‹é—´éš”ï¼ˆå½“å‰æ˜¯ `scheduled_task_time` é…ç½®ï¼‰
- æ·»åŠ æ—¥å¿—æŸ¥çœ‹æ¯æ¬¡æ£€æµ‹çš„ç»“æœ

### Q2: æ¨¡æ‹Ÿæµ‹è¯•èƒ½ç”Ÿæˆæ¶ˆæ¯ï¼Œä½†çœŸå®åœºæ™¯ä¸è¡Œï¼Ÿ

**é—®é¢˜åœ¨ï¼š** æ•°æ®æ¯”å¯¹ç¯èŠ‚

**æ’æŸ¥ï¼š**
1. æ‰‹åŠ¨ `/refresh` åæŸ¥çœ‹æ—¥å¿—
2. æ£€æŸ¥ `HulaquanDataManager.py` ä¸­çš„ `compare_to_database_async` æ–¹æ³•
3. å¯èƒ½æ˜¯ç½‘ç»œé—®é¢˜ã€APIå˜åŒ–ã€æˆ–æ•°æ®æ ¼å¼é—®é¢˜

### Q3: æ¶ˆæ¯ç”Ÿæˆäº†ï¼Œä½†ç”¨æˆ·æ²¡æ”¶åˆ°ï¼Ÿ

**å¯èƒ½åŸå› ï¼š**
1. API å‘é€å¤±è´¥ï¼ˆ`retcode != 0`ï¼‰
2. ç”¨æˆ·å±è”½äº†æœºå™¨äºº
3. æ¶ˆæ¯è¢«é£æ§

**æ’æŸ¥ï¼š**
- æŸ¥çœ‹æ—¥å¿—ä¸­çš„ `retcode`
- ä»£ç ä¸­æœ‰ `if r['retcode'] == 1200` çš„å¤„ç†ï¼ˆç”¨æˆ·ä¸å­˜åœ¨ï¼‰

### Q4: åªæœ‰éƒ¨åˆ†ç”¨æˆ·æ”¶ä¸åˆ°ï¼Ÿ

**æ’æŸ¥ï¼š**
- ä½¿ç”¨ `/debugé€šçŸ¥ user` æŸ¥çœ‹è¯¥ç”¨æˆ·çš„è®¾ç½®
- æ£€æŸ¥è¯¥ç”¨æˆ·æ˜¯å¦åœ¨å¥½å‹åˆ—è¡¨ä¸­
- æŸ¥çœ‹æ—¥å¿—ä¸­è¯¥ç”¨æˆ·çš„æ¶ˆæ¯å‘é€æƒ…å†µ

---

## æ¨¡æ‹ŸçœŸå®ä¸Šæ–°åœºæ™¯

å¦‚æœæƒ³å®Œæ•´æµ‹è¯•æ•´ä¸ªæµç¨‹ï¼Œå¯ä»¥ï¼š

### æ–¹æ³•1ï¼šä¿®æ”¹ä»£ç ï¼Œæ³¨å…¥æ¨¡æ‹Ÿæ•°æ®

åœ¨ `on_hulaquan_announcer` ä¸­ä¸´æ—¶æ·»åŠ ï¼š

```python
async def on_hulaquan_announcer(self, test=False, manual=False, announce_admin_only=False):
    # ... åŸæœ‰ä»£ç è·å– result
    
    # ã€æµ‹è¯•ç”¨ã€‘æ³¨å…¥æ¨¡æ‹Ÿä¸Šæ–°æ•°æ®
    if test:
        result["categorized"]["new"].append("99999")
        result["tickets"]["99999"] = {
            "id": "99999",
            "event_id": "9999",
            "categorized": "new",
            "message": "[æµ‹è¯•] æµ‹è¯•å‰§ç›® | 2025-10-20 | AåŒº | Â¥100"
        }
        result["events"]["9999"] = ["99999"]
        result["events_prefixes"]["9999"] = "ã€æµ‹è¯•å‰§ç›®ã€‘"
    
    # ... ç»§ç»­åŸæœ‰é€»è¾‘
```

ç„¶åè°ƒç”¨ï¼š
```python
await plugin.on_hulaquan_announcer(test=True, announce_admin_only=True)
```

### æ–¹æ³•2ï¼šä½¿ç”¨ debug_announcer.py

```python
from plugins.Hulaquan.debug_announcer import run_debug_tests

# å®Œæ•´è°ƒè¯•æµç¨‹
await run_debug_tests(plugin_instance)
```

---

## æ¨èçš„è°ƒè¯•é¡ºåº

```
1. /debugé€šçŸ¥ check     â†’ ç¡®è®¤ä»»åŠ¡è¿è¡Œ
2. /debugé€šçŸ¥ user      â†’ ç¡®è®¤ç”¨æˆ·è®¾ç½®
3. /debugé€šçŸ¥ mock      â†’ æµ‹è¯•æ¶ˆæ¯ç”Ÿæˆ
4. /refresh             â†’ æ‰‹åŠ¨è§¦å‘åˆ·æ–°
5. æŸ¥çœ‹æ—¥å¿—             â†’ åˆ†æé—®é¢˜ç‚¹
6. ä»£ç å±‚é¢è°ƒè¯•         â†’ æ·±å…¥æ’æŸ¥
```

---

## å¿«é€Ÿæ£€æŸ¥æ¸…å•

- [ ] å®šæ—¶ä»»åŠ¡æ˜¯å¦åœ¨è¿è¡Œï¼Ÿ
- [ ] ç”¨æˆ·å…¨å±€æ¨¡å¼æ˜¯å¦ä¸º 1/2/3ï¼Ÿ
- [ ] æ¨¡æ‹Ÿæµ‹è¯•èƒ½å¦ç”Ÿæˆæ¶ˆæ¯ï¼Ÿ
- [ ] `Hlq.compare_to_database_async()` æ˜¯å¦è¿”å›æ•°æ®ï¼Ÿ
- [ ] æ—¥å¿—ä¸­æ˜¯å¦æœ‰é”™è¯¯ä¿¡æ¯ï¼Ÿ
- [ ] API å‘é€æ˜¯å¦æˆåŠŸï¼ˆretcode=0ï¼‰ï¼Ÿ
- [ ] ç”¨æˆ·æ˜¯å¦åœ¨å¥½å‹åˆ—è¡¨ä¸­ï¼Ÿ
- [ ] æ£€æµ‹é—´éš”æ˜¯å¦åˆç†ï¼Ÿ

---

## è”ç³»æ”¯æŒ

å¦‚æœä»¥ä¸Šæ–¹æ³•éƒ½æ— æ³•è§£å†³é—®é¢˜ï¼Œè¯·æä¾›ï¼š
1. `/debugé€šçŸ¥ check` çš„è¾“å‡º
2. `/debugé€šçŸ¥ user` çš„è¾“å‡º
3. `/debugé€šçŸ¥ mock` çš„è¾“å‡º
4. æœ€è¿‘çš„æ—¥å¿—æ–‡ä»¶ï¼ˆ`logs/bot.log`ï¼‰
5. å…·ä½“çš„åœºæ™¯æè¿°ï¼ˆä»€ä¹ˆæ—¶å€™åº”è¯¥æ”¶åˆ°ä½†æ²¡æ”¶åˆ°ï¼‰
