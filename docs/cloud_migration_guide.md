# 云端用户数据迁移指南

## 📋 脚本说明

[`migrate_cloud_users.py`](file:///Users/yaobii/Developer/MY%20PROJECTS/MusicalBot/scripts/migrate_cloud_users.py) 是一个完整的一键迁移脚本，包含：

1. **自动备份** - 在操作前自动备份数据库
2. **保留核心用户** - 保护 `000001` 和 `000002`
3. **数据清理** - 删除其他用户的旧数据
4. **重新导入** - 使用标准 6 位 ID 格式导入历史用户
5. **完整性验证** - 自动检查迁移结果
6. **详细报告** - 输出完整的迁移报告

## 🚀 云端部署步骤

### 1. 上传脚本到服务器

```bash
# 在本地执行
scp scripts/migrate_cloud_users.py yyj:/opt/MusicalBot/scripts/
```

### 2. SSH 登录服务器

```bash
ssh yyj
cd /opt/MusicalBot
```

### 3. 执行迁移

```bash
# 推荐：先预览（不加 --force，会要求确认）
source .venv/bin/activate
python3.12 scripts/migrate_cloud_users.py

# 或者直接执行（跳过确认）
python3.12 scripts/migrate_cloud_users.py --force
```

### 4. 检查结果

脚本会在最后输出详细的迁移报告，包括：

- 备份文件路径
- 保留的用户
- 删除和导入的数量
- 是否有错误

### 5. 重启服务

```bash
./dev.sh restart
```

## 📊 预期输出示例

```
============================================================
🚀 云端用户数据一键迁移脚本
============================================================

📦 步骤 1: 备份数据库...
✅ 备份完成: backups/musicalbot_before_migration_20260120_223000.db

🗑️  步骤 2: 清理用户数据（保留 000001, 000002）...
   发现 184 个用户，将删除 182 个
✅ 清理完成，删除了 182 个用户

📥 步骤 3: 导入历史用户...
   发现 182 个历史用户
   ID 计数器: 从 000003 开始
✅ 导入完成:
   - 创建用户: 181
   - 创建认证绑定: 181
   - 导入剧目: 148
   - 导入演员: 54

🔍 步骤 4: 验证迁移结果...
   总用户数: 183
   核心用户: ✅ 完好
   ID 格式: ✅ 全部正确

============================================================
📋 迁移报告
============================================================
备份文件: backups/musicalbot_before_migration_20260120_223000.db

保留用户: 2 个
  - 000001: contact (contact@yaobii.com)
  - 000002: 摇摇柚香芒果西米杯 (无邮箱)

删除用户: 182 个
导入用户: 181 个

✅ 迁移成功，无错误
============================================================
```

## ⚠️ 注意事项

1. **备份自动创建** - 脚本会自动在 `backups/` 目录创建备份
2. **幂等性** - 脚本可以安全地多次运行
3. **错误恢复** - 如果出错，可从备份恢复：

   ```bash
   cp backups/musicalbot_before_migration_XXXXXX.db data/musicalbot.db
   ```

## 🔧 故障排查

### 问题：找不到历史数据文件

确保 `plugins_legacy/data_legacy_260118_final/data/data_manager/UsersManager.json` 存在。

### 问题：数据库路径错误

脚本默认使用 `data/musicalbot.db`，如需修改请编辑脚本中的 `DB_PATH` 变量。

### 问题：导入后用户数不对

检查迁移报告中的 "跳过未激活" 和 "跳过已存在" 数量。
