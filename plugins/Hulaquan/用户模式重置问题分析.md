# ç”¨æˆ· attention_to_hulaquan å˜æˆ 0 çš„åŸå› åˆ†æ

## ğŸ” è°ƒæŸ¥ç»“è®º

ç»è¿‡æ·±å…¥æ£€æŸ¥ä»£ç ï¼Œ**æ²¡æœ‰å‘ç°ä¼šè‡ªåŠ¨å°†ç”¨æˆ·æ¨¡å¼é‡ç½®ä¸º 0 çš„é€»è¾‘**ã€‚

---

## âœ… å·²æ’é™¤çš„å¯èƒ½æ€§

### 1. âŒ add_user ä¸ä¼šè¦†ç›–ç°æœ‰ç”¨æˆ·
```python
def add_user(self, user_id):
    if user_id in self.data["users_list"]:
        return  # å¦‚æœç”¨æˆ·å·²å­˜åœ¨ï¼Œç›´æ¥è¿”å›ï¼Œä¸ä¼šè¦†ç›–
    # åªæœ‰æ–°ç”¨æˆ·æ‰ä¼šåˆå§‹åŒ–ä¸º 0
    self.data["users"][user_id] = USER_MODEL()
```

### 2. âŒ update_user_keys ä¸ä¼šé‡ç½®ç°æœ‰å€¼
```python
def update_user_keys(self, user_id):
    def goto(origin, model):
        for k, v in model.items():
            if k not in origin:
                origin[k] = v  # åªæ·»åŠ ç¼ºå¤±çš„key
            # ä¸ä¼šè¦†ç›–å·²å­˜åœ¨çš„å€¼
```

### 3. âŒ check_friend_status ä¸ä¼šé‡ç½®
```python
async def check_friend_status(self, bot):
    for user_id in self.users_list():
        if user_id not in friends:
            # åˆ é™¤ä¸åœ¨å¥½å‹åˆ—è¡¨çš„ç”¨æˆ·
            if r['retcode'] == 1200:
                self.delete_user(user_id)
        else:
            self.add_user(user_id)  # å·²å­˜åœ¨æ—¶ä¸ä¼šè¦†ç›–
```

### 4. âŒ switch_attention_to_hulaquan éœ€è¦æ˜¾å¼è°ƒç”¨
```python
def switch_attention_to_hulaquan(self, user_id, mode=0, is_group=False):
    # åªæœ‰ç”¨æˆ·å‘é€ /å‘¼å•¦åœˆé€šçŸ¥ å‘½ä»¤æ—¶æ‰ä¼šè°ƒç”¨
    self.data[key][user_id]["attention_to_hulaquan"] = mode
```

---

## âš ï¸ å¯èƒ½çš„çœŸå®åŸå› 

### åŸå› 1ï¼šæ•°æ®ä¿å­˜å¤±è´¥ï¼ˆæœ€å¯èƒ½ï¼‰

**åœºæ™¯ï¼š**
1. ç”¨æˆ·è®¾ç½®äº†æ¨¡å¼ 1/2/3
2. æ•°æ®åœ¨å†…å­˜ä¸­æ›´æ–°æˆåŠŸ
3. ä½†ä¿å­˜åˆ°æ–‡ä»¶æ—¶å¤±è´¥ï¼ˆç£ç›˜æ»¡ã€æƒé™é—®é¢˜ã€ç¨‹åºå´©æºƒç­‰ï¼‰
4. é‡å¯åä»æ—§æ–‡ä»¶åŠ è½½ï¼Œç”¨æˆ·æ¨¡å¼è¿˜æ˜¯ 0

**è¯æ®ï¼š**
- ä¿å­˜é€»è¾‘åœ¨ `BaseDataManager.save()` ä¸­
- å¦‚æœ `self.updating = True` æ—¶ä¿å­˜ä¼šå¤±è´¥
- å¦‚æœå†™å…¥ç£ç›˜å¤±è´¥ï¼Œæ•°æ®ä¼šä¸¢å¤±

**è§£å†³æ–¹æ¡ˆï¼š**
- å¢åŠ ä¿å­˜æ—¥å¿—
- æ£€æŸ¥å¤‡ä»½æ–‡ä»¶ï¼ˆ`.bak`ï¼‰
- å®šæœŸæ£€æŸ¥æ•°æ®æ–‡ä»¶å®Œæ•´æ€§

---

### åŸå› 2ï¼šæ•°æ®æ–‡ä»¶è¢«è¦†ç›–/æ¢å¤

**åœºæ™¯ï¼š**
1. ç”¨æˆ·è®¾ç½®äº†æ¨¡å¼
2. ä½†æŸäº›åŸå› å¯¼è‡´æ•°æ®æ–‡ä»¶è¢«æ—§ç‰ˆæœ¬è¦†ç›–ï¼š
   - ä»å¤‡ä»½æ¢å¤
   - Git æ“ä½œå¯¼è‡´æ–‡ä»¶å›æ»š
   - å¤šä¸ªè¿›ç¨‹åŒæ—¶å†™å…¥

**è¯æ®ï¼š**
- æ•°æ®æ–‡ä»¶è·¯å¾„ï¼š`data/data_manager/UsersManager.json`
- æœ‰å¤‡ä»½æœºåˆ¶ï¼š`UsersManager.json.bak`

**è§£å†³æ–¹æ¡ˆï¼š**
- æ£€æŸ¥ Git å†å²
- ç¡®ä¿åªæœ‰ä¸€ä¸ª Bot å®ä¾‹è¿è¡Œ
- å¯ç”¨æ–‡ä»¶é”æœºåˆ¶

---

### åŸå› 3ï¼šç”¨æˆ·è¯¯æ“ä½œ

**åœºæ™¯ï¼š**
- ç”¨æˆ·è‡ªå·±å‘é€äº† `/å‘¼å•¦åœˆé€šçŸ¥ 0`
- ä½†å¿˜è®°äº†

**è¯æ®ï¼š**
- è¿™æ˜¯å”¯ä¸€èƒ½æ”¹å˜æ¨¡å¼çš„ç”¨æˆ·å‘½ä»¤

**è§£å†³æ–¹æ¡ˆï¼š**
- æ·»åŠ æ“ä½œæ—¥å¿—
- è®°å½•æ¨¡å¼å˜æ›´å†å²

---

### åŸå› 4ï¼šæ•°æ®æ–‡ä»¶æŸå

**åœºæ™¯ï¼š**
1. JSON æ–‡ä»¶æŸå
2. åŠ è½½æ—¶æŠ›å‡º `JSONDecodeError`
3. `self.data = {}` é‡ç½®ä¸ºç©ºå­—å…¸
4. æ‰€æœ‰ç”¨æˆ·æ•°æ®ä¸¢å¤±

**è¯æ®ï¼š**
```python
def load(self):
    try:
        self.data = json.load(f)
    except json.JSONDecodeError as e:
        self.data = {}  # âš ï¸ æ‰€æœ‰æ•°æ®ä¸¢å¤±
        raise
```

**è§£å†³æ–¹æ¡ˆï¼š**
- æ£€æŸ¥æ—¥å¿—ä¸­æ˜¯å¦æœ‰ JSONDecodeError
- ä½¿ç”¨å¤‡ä»½æ–‡ä»¶æ¢å¤
- å¢å¼ºé”™è¯¯å¤„ç†ï¼Œå°è¯•ä¿®å¤æŸåçš„ JSON

---

## ğŸ› ï¸ æ¨èçš„æ’æŸ¥æ–¹æ³•

### 1. æ·»åŠ è¯¦ç»†æ—¥å¿—

ä¿®æ”¹ `switch_attention_to_hulaquan` æ–¹æ³•ï¼š

```python
def switch_attention_to_hulaquan(self, user_id, mode=0, is_group=False):
    if not isinstance(user_id, str):
        user_id = str(user_id)
    key = "users" if not is_group else "groups"
    
    # è®°å½•æ—§å€¼
    old_mode = self.data[key].get(user_id, {}).get("attention_to_hulaquan", "N/A")
    
    try:
        self.data[key][user_id]["attention_to_hulaquan"] = mode
    except KeyError:
        if key == "users":
            self.add_user(user_id)
        else:
            self.add_group(user_id)
        self.data[key][user_id]["attention_to_hulaquan"] = mode
    
    # è®°å½•å˜æ›´
    log.info(f"ğŸ”„ [æ¨¡å¼å˜æ›´] {key}={user_id}, {old_mode} -> {mode}")
    return mode
```

### 2. æ·»åŠ ä¿å­˜æˆåŠŸæ—¥å¿—

ä¿®æ”¹ `save_all` å‡½æ•°ï¼š

```python
async def save_all(on_close=False):
    success = 1
    log.info("ğŸ’¾ [å¼€å§‹ä¿å­˜] ä¿å­˜æ‰€æœ‰æ•°æ®ç®¡ç†å™¨")
    for manager in managers:
        result = await manager.save(on_close)
        success *= int(result['success'])
        if result['success']:
            log.info(f"âœ… [ä¿å­˜æˆåŠŸ] {manager.__class__.__name__}")
        else:
            log.error(f"âŒ [ä¿å­˜å¤±è´¥] {manager.__class__.__name__}, updating={result.get('updating')}")
    return bool(success)
```

### 3. å®šæœŸå¤‡ä»½æ•°æ®æ–‡ä»¶

æ·»åŠ è‡ªåŠ¨å¤‡ä»½ä»»åŠ¡ï¼š

```python
async def backup_user_data(self):
    """æ¯å¤©è‡ªåŠ¨å¤‡ä»½ç”¨æˆ·æ•°æ®"""
    import shutil
    from datetime import datetime
    
    source = "data/data_manager/UsersManager.json"
    timestamp = datetime.now().strftime("%Y%m%d_%H%M%S")
    backup = f"data/backups/UsersManager_{timestamp}.json"
    
    os.makedirs("data/backups", exist_ok=True)
    shutil.copy2(source, backup)
    log.info(f"ğŸ“¦ [å¤‡ä»½å®Œæˆ] {backup}")
```

### 4. æ£€æŸ¥æ•°æ®å®Œæ•´æ€§

æ·»åŠ éªŒè¯å·¥å…·ï¼š

```python
def validate_user_data(self):
    """éªŒè¯ç”¨æˆ·æ•°æ®å®Œæ•´æ€§"""
    issues = []
    
    for user_id in self.data.get("users_list", []):
        user = self.data.get("users", {}).get(user_id)
        
        if user is None:
            issues.append(f"ç”¨æˆ· {user_id} åœ¨ users_list ä¸­ä½†ä¸åœ¨ users å­—å…¸ä¸­")
            continue
        
        if "attention_to_hulaquan" not in user:
            issues.append(f"ç”¨æˆ· {user_id} ç¼ºå°‘ attention_to_hulaquan å­—æ®µ")
        
        mode = user.get("attention_to_hulaquan")
        if mode not in [0, 1, 2, 3, "0", "1", "2", "3"]:
            issues.append(f"ç”¨æˆ· {user_id} çš„æ¨¡å¼å€¼æ— æ•ˆ: {mode}")
    
    if issues:
        log.warning(f"âš ï¸ [æ•°æ®éªŒè¯] å‘ç° {len(issues)} ä¸ªé—®é¢˜:\n" + "\n".join(issues))
    else:
        log.info("âœ… [æ•°æ®éªŒè¯] ç”¨æˆ·æ•°æ®å®Œæ•´")
    
    return issues
```

---

## ğŸ“Š ç«‹å³æ£€æŸ¥é¡¹

### 1. æŸ¥çœ‹æœ€è¿‘çš„æ—¥å¿—
```powershell
Select-String -Path f:\MusicalBot\logs\bot.log -Pattern "æ¨¡å¼|attention|switch" | Select-Object -Last 50
```

### 2. æ£€æŸ¥æ•°æ®æ–‡ä»¶
```powershell
# æŸ¥çœ‹ä¸»æ–‡ä»¶
Get-Content f:\MusicalBot\data\data_manager\UsersManager.json | ConvertFrom-Json

# æŸ¥çœ‹å¤‡ä»½æ–‡ä»¶
Get-Content f:\MusicalBot\data\data_manager\UsersManager.json.bak | ConvertFrom-Json
```

### 3. æ¯”è¾ƒæ–‡ä»¶å·®å¼‚
```powershell
# æ£€æŸ¥ä¸»æ–‡ä»¶å’Œå¤‡ä»½æ˜¯å¦ä¸€è‡´
$main = Get-Content f:\MusicalBot\data\data_manager\UsersManager.json
$backup = Get-Content f:\MusicalBot\data\data_manager\UsersManager.json.bak
Compare-Object $main $backup
```

### 4. æŸ¥çœ‹æ–‡ä»¶ä¿®æ”¹æ—¶é—´
```powershell
Get-ChildItem f:\MusicalBot\data\data_manager\UsersManager.json* | 
    Select-Object Name, LastWriteTime, Length
```

---

## ğŸ¯ æœ€ç»ˆå»ºè®®

1. **ç«‹å³æ·»åŠ æ—¥å¿—** - è®°å½•æ‰€æœ‰æ¨¡å¼å˜æ›´
2. **æ£€æŸ¥å¤‡ä»½æ–‡ä»¶** - å¯¹æ¯”ä¸»æ–‡ä»¶å’Œå¤‡ä»½
3. **ç›‘æ§ä¿å­˜è¿‡ç¨‹** - ç¡®è®¤æ•°æ®æ­£ç¡®ä¿å­˜
4. **å®šæœŸå¤‡ä»½** - é¿å…æ•°æ®ä¸¢å¤±
5. **æ·»åŠ æ•°æ®éªŒè¯** - å¯åŠ¨æ—¶æ£€æŸ¥æ•°æ®å®Œæ•´æ€§

---

## ğŸ“ éœ€è¦æ”¶é›†çš„ä¿¡æ¯

å¦‚æœé—®é¢˜å†æ¬¡å‘ç”Ÿï¼Œè¯·æä¾›ï¼š

1. âœ… ç”¨æˆ· ID å’Œå‘ç”Ÿæ—¶é—´
2. âœ… è¯¥æ—¶æ®µçš„æ—¥å¿—æ–‡ä»¶
3. âœ… UsersManager.json å’Œ .bak æ–‡ä»¶
4. âœ… ç”¨æˆ·æ˜¯å¦è®°å¾—å‘é€è¿‡å‘½ä»¤
5. âœ… Bot æ˜¯å¦é‡å¯è¿‡
6. âœ… ç£ç›˜ç©ºé—´æ˜¯å¦å……è¶³
