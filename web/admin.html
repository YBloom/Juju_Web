<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MusicalBot Admin</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Source+Code+Pro:wght@400;500&family=Inter:wght@400;600&display=swap"
        rel="stylesheet">
    <style>
        :root {
            --primary: #637E60;
            --bg: #f5f5f5;
            --card-bg: #ffffff;
            --terminal-bg: #1e1e1e;
            --terminal-text: #d4d4d4;
            --border: #e0e0e0;
        }

        body {
            margin: 0;
            font-family: 'Inter', system-ui, sans-serif;
            background: var(--bg);
            color: #333;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .header {
            background: var(--card-bg);
            padding: 0 20px;
            height: 60px;
            display: flex;
            align-items: center;
            border-bottom: 1px solid var(--border);
            justify-content: space-between;
            flex-shrink: 0;
        }

        .logo {
            font-weight: 600;
            color: var(--primary);
            font-size: 1.2rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .status-badge {
            font-size: 0.75rem;
            background: #e6f4ea;
            color: #1e7e34;
            padding: 4px 10px;
            border-radius: 20px;
            font-weight: 600;
        }

        .badge-live {
            display: inline-block;
            width: 8px;
            height: 8px;
            background: #1e7e34;
            border-radius: 50%;
            margin-right: 6px;
        }

        .main-container {
            flex: 1;
            display: flex;
            overflow: hidden;
        }

        .sidebar {
            width: 220px;
            background: var(--card-bg);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            padding: 20px 0;
            flex-shrink: 0;
        }

        .nav-item {
            padding: 12px 24px;
            cursor: pointer;
            color: #666;
            font-size: 0.95rem;
            font-weight: 500;
            transition: all 0.2s;
            border-left: 3px solid transparent;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .nav-item:hover {
            background: rgba(0, 0, 0, 0.03);
            color: #333;
        }

        .nav-item.active {
            background: rgba(99, 126, 96, 0.08);
            color: var(--primary);
            border-left-color: var(--primary);
        }

        .nav-item svg {
            width: 18px;
            height: 18px;
            opacity: 0.8;
        }

        .content-area {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }

        .panel {
            display: none;
            height: 100%;
            flex-direction: column;
        }

        .panel.active {
            display: flex;
        }

        .toolbar {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            align-items: center;
        }

        .btn {
            border: 1px solid var(--border);
            background: white;
            padding: 6px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            color: #555;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: all 0.2s;
        }

        .btn:hover {
            background: #f9f9f9;
            border-color: #ccc;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        .btn-primary:hover {
            background: #526950;
            border-color: #526950;
        }

        select {
            padding: 6px 10px;
            border-radius: 6px;
            border: 1px solid var(--border);
            font-size: 0.9rem;
            outline: none;
        }

        .terminal-window {
            flex: 1;
            background: var(--terminal-bg);
            color: var(--terminal-text);
            font-family: 'Source Code Pro', monospace;
            padding: 20px;
            border-radius: 8px;
            font-size: 0.85rem;
            overflow-y: auto;
            line-height: 1.6;
            white-space: pre-wrap;
            word-wrap: break-word;
            box-shadow: inset 0 0 20px rgba(0, 0, 0, 0.2);
        }

        .log-line {
            margin: 2px 0;
            display: block;
            padding: 2px 0;
        }

        .log-error {
            color: #ff6b6b;
            font-weight: 500;
        }

        .log-warn,
        .log-warning {
            color: #ffd93d;
        }

        .log-info {
            color: #6bcbef;
        }

        .log-timestamp {
            color: #888;
            font-weight: 500;
        }

        .log-level-error {
            color: #ff6b6b;
            font-weight: 600;
        }

        .log-level-warning {
            color: #ffd93d;
            font-weight: 600;
        }

        .log-level-info {
            color: #6bcbef;
            font-weight: 600;
        }

        .log-indent {
            padding-left: 20px;
            color: #b0b0b0;
        }

        /* Umami Card */
        .analytics-card {
            background: white;
            border-radius: 12px;
            border: 1px solid var(--border);
            overflow: hidden;
            padding: 40px;
            text-align: center;
            max-width: 600px;
            margin: 40px auto;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.03);
        }

        .analytics-icon {
            font-size: 48px;
            margin-bottom: 20px;
            display: block;
        }
    </style>
</head>

<body>

    <div class="header">
        <div class="logo">
            <span>ğŸ›¡ï¸ MusicalBot Admin</span>
        </div>
        <div class="status-badge"><span class="badge-live"></span>SERVICE RUNNING</div>
    </div>

    <div class="main-container">
        <div class="sidebar">
            <div class="nav-item active" onclick="switchTab('logs')">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"></path>
                    <polyline points="13 2 13 9 20 9"></polyline>
                </svg>
                ç³»ç»Ÿæ—¥å¿—
            </div>
            <div class="nav-item" onclick="switchTab('analytics')">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M3 3v18h18"></path>
                    <path d="M18.7 8l-5.1 5.2-2.8-2.7L7 14.3"></path>
                </svg>
                Umami åˆ†æ
            </div>
        </div>

        <div class="content-area">
            <!-- Logs Panel -->
            <div id="panel-logs" class="panel active">
                <div class="toolbar">
                    <select id="log-file-select" onchange="loadLogs()">
                        <option value="web_out.log">Web Output (web_out.log)</option>
                        <option value="web_err.log">Web Errors (web_err.log)</option>
                        <option value="auto_update.log">Auto Update (auto_update.log)</option>
                    </select>
                    <div style="flex:1"></div>
                    <label
                        style="display:flex; align-items:center; gap:5px; font-size:0.85rem; cursor:pointer; margin-right:10px">
                        <input type="checkbox" id="auto-scroll" checked> è‡ªåŠ¨æ»šåŠ¨
                    </label>
                    <label
                        style="display:flex; align-items:center; gap:5px; font-size:0.85rem; cursor:pointer; margin-right:10px">
                        <input type="checkbox" id="auto-refresh" onchange="toggleAutoRefresh(this)"> è‡ªåŠ¨åˆ·æ–° (5s)
                    </label>
                    <button class="btn btn-primary" onclick="loadLogs()">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2">
                            <polyline points="23 4 23 10 17 10"></polyline>
                            <polyline points="1 20 1 14 7 14"></polyline>
                            <path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path>
                        </svg>
                        åˆ·æ–°
                    </button>
                </div>
                <div id="terminal" class="terminal-window">Loading logs...</div>
            </div>

            <!-- Analytics Panel -->
            <div id="panel-analytics" class="panel">
                <div class="analytics-card">
                    <span class="analytics-icon">ğŸ“Š</span>
                    <h2 style="margin-top:0; color:var(--primary)">æµé‡åˆ†æ & ç›‘æ§</h2>
                    <p style="color:#666; margin-bottom:30px; line-height:1.6">
                        MusicalBot ä½¿ç”¨è‡ªæ‰˜ç®¡çš„ Umami è¿›è¡Œéšç§å‹å¥½çš„æ•°æ®ç»Ÿè®¡ã€‚<br>
                        è¯·ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®å‰å¾€ Umami ç®¡ç†æ§åˆ¶å°æŸ¥çœ‹å®Œæ•´æŠ¥è¡¨ã€‚
                    </p>
                    <a href="https://analytics.yaobii.com" target="_blank" class="btn btn-primary"
                        style="display:inline-flex; padding:12px 24px; font-size:1rem; text-decoration:none;">
                        æ‰“å¼€ Umami æ§åˆ¶å° <svg style="margin-left:8px; width:16px;" viewBox="0 0 24 24" fill="none"
                            stroke="currentColor" stroke-width="2">
                            <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path>
                            <polyline points="15 3 21 3 21 9"></polyline>
                            <line x1="10" y1="14" x2="21" y2="3"></line>
                        </svg>
                    </a>
                </div>
            </div>
        </div>
    </div>

    <script>
        let refreshInterval = null;

        function switchTab(tabId) {
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.panel').forEach(el => el.classList.remove('active'));

            event.currentTarget.classList.add('active');
            document.getElementById('panel-' + tabId).classList.add('active');
        }

        function toggleAutoRefresh(checkbox) {
            if (checkbox.checked) {
                refreshInterval = setInterval(loadLogs, 5000);
            } else {
                clearInterval(refreshInterval);
            }
        }

        async function loadLogs() {
            const file = document.getElementById('log-file-select').value;
            const term = document.getElementById('terminal');
            const autoScroll = document.getElementById('auto-scroll').checked;

            try {
                // Using a cache bust param to ensure fresh logs
                const res = await fetch(`/api/admin/logs?file=${file}&t=${Date.now()}`);
                if (res.status === 401) {
                    location.reload(); // Force re-auth
                    return;
                }
                if (!res.ok) throw new Error("Failed to load");

                const text = await res.text();

                // æ”¹è¿›çš„è¯­æ³•é«˜äº®,æ”¯æŒæ¢è¡Œç¬¦æ¸²æŸ“
                const html = text.split('\n').map(line => {
                    if (!line.trim()) return '<br>'; // ç©ºè¡Œ

                    let processedLine = escapeHtml(line);
                    let cls = 'log-line';

                    // æ£€æµ‹ç¼©è¿›è¡Œ(ä»¥ç©ºæ ¼å¼€å¤´)
                    if (line.match(/^\s{4,}/)) {
                        cls += ' log-indent';
                    }

                    // é«˜äº®æ—¶é—´æˆ³ (åŒ¹é… YYYY-MM-DD HH:MM:SS æ ¼å¼)
                    processedLine = processedLine.replace(
                        /(\d{4}-\d{2}-\d{2}\s+\d{2}:\d{2}:\d{2}(?:\s+CST)?)/g,
                        '<span class="log-timestamp">$1</span>'
                    );

                    // é«˜äº®æ—¥å¿—çº§åˆ«
                    processedLine = processedLine.replace(
                        /\[(ERROR|ERRO)\]/gi,
                        '<span class="log-level-error">[$1]</span>'
                    );
                    processedLine = processedLine.replace(
                        /\[(WARNING|WARN)\]/gi,
                        '<span class="log-level-warning">[$1]</span>'
                    );
                    processedLine = processedLine.replace(
                        /\[(INFO)\]/gi,
                        '<span class="log-level-info">[$1]</span>'
                    );

                    // æ£€æµ‹æ•´è¡Œçº§åˆ«
                    if (line.toLowerCase().includes('error')) {
                        cls += ' log-error';
                    } else if (line.toLowerCase().includes('warn')) {
                        cls += ' log-warning';
                    } else if (line.includes('INFO')) {
                        cls += ' log-info';
                    }

                    return `<span class="${cls}">${processedLine}</span>`;
                }).join('\u003cbr\u003e');

                term.innerHTML = html || '<span style="color:#666">No content or empty log file.</span>';

                if (autoScroll) {
                    term.scrollTop = term.scrollHeight;
                }
            } catch (e) {
                term.innerHTML = `<span class="log-error">Error loading logs: ${e.message}</span>`;
            }
        }

        function escapeHtml(text) {
            return text.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;");
        }

        // Initial Load
        loadLogs();
    </script>
</body>

</html>